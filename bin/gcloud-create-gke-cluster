#!/usr/bin/env bash

# This creates a new Kubernetes cluster on GKE

# make bash play nicely
#
set -o pipefail -o errtrace -o errexit -o nounset
shopt -s inherit_errexit
[[ -n "${TRACE:-}" ]] && set -o xtrace

# Required env vars
CLOUDSDK_CORE_PROJECT="${CLOUDSDK_CORE_PROJECT:?CLOUDSDK_CORE_PROJECT is required}"
CLOUDSDK_CONTAINER_CLUSTER="${CLOUDSDK_CONTAINER_CLUSTER:?CLOUDSDK_CONTAINER_CLUSTER is required}"
CLOUDSDK_COMPUTE_ZONE="${CLOUDSDK_COMPUTE_ZONE:?CLOUDSDK_COMPUTE_ZONE is required}"

# Parameters
NODE_MACHINE="e2-standard-2"
#v4.4 has core and read replicas hence the test case require more nodes
# we can move to autoscaling in future but with autoscaling enabled the node provisioning might take some time
# which will increase the total test time
NUM_NODES="15"

# For more info on release channels see https://cloud.google.com/kubernetes-engine/docs/concepts/release-channels
RELEASE_CHANNEL="stable"

# make a new Kubernetes cluster
#

echo "NUMBER OF NODES ${NUM_NODES}"
gcloud container clusters create "${CLOUDSDK_CONTAINER_CLUSTER}" \
     --release-channel=${RELEASE_CHANNEL} \
     --zone="${CLOUDSDK_COMPUTE_ZONE}" \
     --num-nodes "${NUM_NODES}" \
     --workload-pool="${CLOUDSDK_CORE_PROJECT}.svc.id.goog" \
     --preemptible --machine-type "${NODE_MACHINE}" --image-type "COS_CONTAINERD" \
     --disk-type "pd-ssd" --disk-size "40" \
     --max-pods-per-node=30 --enable-ip-alias \
     --enable-shielded-nodes --metadata disable-legacy-endpoints=true --no-enable-basic-auth


gcloud-configure-kubectl
